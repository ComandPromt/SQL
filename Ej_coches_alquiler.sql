ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY';

DROP TABLE COCHE_USADO CASCADE CONSTRAINTS;
DROP TABLE CLIENTE  CASCADE CONSTRAINTS;
DROP TABLE COMPRA  CASCADE CONSTRAINTS;
DROP TABLE INCLUYE CASCADE CONSTRAINTS;
DROP TABLE COCHE_NUEVO  CASCADE CONSTRAINTS;
DROP TABLE DISPONIBLE  CASCADE CONSTRAINTS;
DROP TABLE OPCION  CASCADE CONSTRAINTS;
DROP TABLE EMPLEADO  CASCADE CONSTRAINTS;
DROP TABLE VENDEDOR  CASCADE CONSTRAINTS;
DROP TABLE MECANICO CASCADE CONSTRAINTS;
DROP TABLE ENTREGA  CASCADE CONSTRAINTS;

CREATE TABLE EMPLEADO(
	DNIE CHAR(9) CHECK (REGEXP_LIKE(DNIE,'^[0-9]{8}[A-Z]$')),
	Nombre VARCHAR2(30),
	Direccion VARCHAR2(50),
	Tlf  NUMBER(9) CHECK (REGEXP_LIKE(Tlf,'^[679][0-9]{8}$')),
	Tipo CHAR(1) CHECK (Tipo IN ('M','V')),
	PRIMARY KEY (DNIE)
);

CREATE TABLE VENDEDOR (
	DNIE CHAR(9),
	PRIMARY KEY(DNIE),
	CONSTRAINT FK_DNIE FOREIGN KEY (DNIE) REFERENCES EMPLEADO(DNIE) ON DELETE CASCADE
);

CREATE TABLE MECANICO (
	DNIE CHAR(9),
	PRIMARY KEY(DNIE),
	FOREIGN KEY (DNIE) REFERENCES EMPLEADO(DNIE) ON DELETE CASCADE
);

CREATE TABLE COCHE_USADO(
	Matricula_Usado CHAR(7),
	Marca VARCHAR2(20),
	Modelo VARCHAR2(20),
	Precio_Trasaccion NUMBER(8,2),
	DNIE CHAR(9),
	PRIMARY KEY (Matricula_Usado),
	FOREIGN KEY (DNIE) REFERENCES MECANICO(DNIE)ON DELETE CASCADE
);

CREATE TABLE CLIENTE(
	DNIC CHAR(9) CHECK (REGEXP_LIKE(DNIC,'^[0-9]{8}[A-Z]$')),
	Nombre VARCHAR2(30),
	Direccion VARCHAR2(50),
	Tlf NUMBER(9) CHECK (REGEXP_LIKE(Tlf,'^[679][0-9]{8}$')),
	PRIMARY KEY (DNIC)
);

CREATE TABLE OPCION(
	IDO INTEGER,
	Nombre VARCHAR2(30),
	Descripcion VARCHAR2(50),
	PRIMARY KEY (IDO)
);

CREATE TABLE COCHE_NUEVO (
	IDV INTEGER,
	Marca VARCHAR2(20),
	Modelo VARCHAR2(20),
	Motor CHAR(1) CHECK (Motor IN('G','D','E','H')),
	Cilindrada NUMBER(4),
	Precio_Base NUMBER(8,2),
	PRIMARY KEY (IDV)
);

CREATE TABLE DISPONIBLE(
	IDV INTEGER,
	IDO INTEGER,
	Precio_Opcion NUMBER(7,2),
	PRIMARY KEY (IDV,IDO),
	FOREIGN KEY (IDV) REFERENCES COCHE_NUEVO(IDV) ON DELETE CASCADE,
	FOREIGN KEY (IDO) REFERENCES OPCION(IDO) ON DELETE CASCADE
);

CREATE TABLE COMPRA (
	IDC INTEGER,
	DNIC CHAR(9),
	IDV INTEGER,
	DNIE CHAR(9),
	PRIMARY KEY(IDC),
	FOREIGN KEY(DNIC) REFERENCES CLIENTE(DNIC) ON DELETE CASCADE,
	FOREIGN KEY(IDV) REFERENCES COCHE_NUEVO(IDV) ON DELETE CASCADE,
	FOREIGN KEY(DNIE) REFERENCES VENDEDOR(DNIE) ON DELETE CASCADE
);

CREATE TABLE ENTREGA(
	IDC INTEGER,
	Matricula_Usado CHAR(7) CHECK (REGEXP_LIKE(Matricula_Usado,'^[0-9]{4}[A-Z]{3}$')),
	PRIMARY KEY (IDC),
	FOREIGN KEY (IDC) REFERENCES COMPRA (IDC) ON DELETE CASCADE,
	FOREIGN KEY (Matricula_Usado) REFERENCES COCHE_USADO (Matricula_Usado) ON DELETE CASCADE
);

CREATE TABLE INCLUYE(
	IDC INTEGER,
	IDO INTEGER,
	Precio NUMBER(7,2),
	PRIMARY KEY(IDC,IDO),
	FOREIGN KEY(IDC) REFERENCES COMPRA(IDC) ON DELETE CASCADE,
	FOREIGN KEY(IDO) REFERENCES OPCION(IDO) ON DELETE CASCADE
);

-- MODIFICAR LA TABLA

ALTER TABLE CLIENTE ADD(
	Apellidos VARCHAR2(30),
	Nacionalidad VARCHAR2(15)
);

ALTER TABLE CLIENTE DROP COLUMN Nacionalidad;

ALTER TABLE CLIENTE MODIFY(
	Apellidos CONSTRAINT APELLIDOS_NO_NULO NOT NULL
);

ALTER TABLE CLIENTE MODIFY(
	Nombre CONSTRAINT NOMBRE_MAYUS CHECK (Nombre = UPPER(Nombre)),
	Apellidos CONSTRAINT APELLIDOS_MAYUS CHECK (Apellidos = UPPER(Apellidos))
);

-- BORRAR RESTRICCIONES

ALTER TABLE CLIENTE DROP CONSTRAINT NOMBRE_MAYUS;

-- AÑADIR RESTRICCION A NIVEL DE TABLA

ALTER TABLE VENDEDOR DROP CONSTRAINT FK_DNIE;

ALTER TABLE VENDEDOR ADD CONSTRAINT FK_DNIE
	FOREIGN KEY (DNIE) REFERENCES EMPLEADO(DNIE);

ALTER TABLE CLIENTE DROP COLUMN Apellidos;

INSERT INTO EMPLEADO VALUES('11111111A','FDS','C/HJ',611000000,'M');
INSERT INTO EMPLEADO VALUES('22222222B','F','C/HJ',622000000,'M');
INSERT INTO EMPLEADO VALUES('33333333C','FD','C/HJ',633000000,'V');

INSERT INTO VENDEDOR VALUES('33333333C');
INSERT INTO MECANICO VALUES('11111111A');
INSERT INTO MECANICO VALUES('22222222B');

INSERT INTO COCHE_USADO VALUES('1000AAA','SEAT','PANDA',1000,'11111111A');
INSERT INTO COCHE_USADO VALUES('2000BBB','RENAULT','R5 COPA TURBO',2000,'22222222B');
INSERT INTO COCHE_USADO VALUES('3000CCC','LAMBORGHINI','GALLARDO',30000,'11111111A');

INSERT INTO CLIENTE VALUES('44444444D','Cristiano Romualdo','C/Penalti','711000000');
INSERT INTO CLIENTE VALUES('55555555E','Mister Handsome','C/Moncloa','755000000');
INSERT INTO CLIENTE VALUES('64578758D','Antonio Negro','C/Tomas Bevia','766000000');

INSERT INTO COCHE_NUEVO VALUES(1,'TOYOTA','COROLA','D',1800,15999.99);
INSERT INTO COCHE_NUEVO VALUES(2,'FERRARI','TESTARROSA','G',4800,150000);

INSERT INTO OPCION VALUES(1,'Elevalunas','Elevalunas electrico en las 4 ventanillas');
INSERT INTO OPCION VALUES(2,'LED','Faros y lueces indicadores de LED');

INSERT INTO DISPONIBLE VALUES(1,1,300);
INSERT INTO DISPONIBLE VALUES(2,1,1300);
INSERT INTO DISPONIBLE VALUES(2,2,2400);

INSERT INTO COMPRA VALUES(1000,'44444444D',2,'33333333C');
INSERT INTO COMPRA VALUES(2000,'64578758D',1,'33333333C');

INSERT INTO INCLUYE VALUES(1000,1,1200);
INSERT INTO INCLUYE VALUES(1000,2,2400);

INSERT INTO ENTREGA VALUES(1000,'3000CCC');
INSERT INTO ENTREGA VALUES(2000,'1000AAA');

-- MODIFICACION

UPDATE CLIENTE SET Nombre='Cristano Ronaldo',Direccion='C/Portugal'
WHERE DNIC='44444444D';

-- SUBIR UN 21% EL PRECIO BASE DE TODOS LOS TOYOTA

UPDATE COCHE_NUEVO SET Precio_Base=Precio_Base*1.21
WHERE Marca='TOYOTA';

-- Borrar

DELETE FROM EMPLEADO WHERE DNIE='11111111A';
